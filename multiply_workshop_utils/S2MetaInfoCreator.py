#!/usr/bin/python

import json
import os
import subprocess
import sys

SWJ_30_POLYGON = 'POLYGON ((-2.9998832732675598 39.74999762096865, -2.840201395652989 39.74988763016868, ' \
                 '-2.6805212696340357 39.74955798247133, -2.5208446454059117 39.74900868855308, ' \
                 '-2.3611732729221067 39.74823976620348, -2.2015089017736194 39.74725124032348, ' \
                 '-2.0418532810682586 39.74604314292308, -1.8822081593100297 39.744615513118354, ' \
                 '-1.7225752842786266 39.742968397127754, -1.7190747137588944 39.742929817128484, ' \
                 '-1.7213496944140254 39.61969974138635, -1.723610738295374 39.49646693521894, ' \
                 '-1.7258579397958433 39.37323140157063, -1.728091392363741 39.249993143426515, ' \
                 '-1.73031118851403 39.126752163812576, -1.7325174198394224 39.00350846579566, ' \
                 '-1.7347101770213105 38.880262052483594, -1.736889549840538 38.7570129270252, ' \
                 '-1.7369371938003195 38.75431006495997, -1.740388980654508 38.75434731832923, ' \
                 '-1.8977969594768438 38.755937794514466, -2.0552165403328235 38.75731632998695, ' \
                 '-2.2126460673887114 38.75848288099789, -2.370083884152631 38.759437410521556, ' \
                 '-2.527528333584071 38.76017988825868, -2.6849777582034817 38.76071029063921, ' \
                 '-2.8424305002019534 38.761028600824446, -2.999884901550939 38.761134808708576, ' \
                 '-2.9998848972079064 38.76383832615107, -2.9998846985448355 38.887117388752735, ' \
                 '-2.9998844986613618 39.01039384140409, -2.9998842975492943 39.133667681769545, ' \
                 '-2.99988409520036 39.25693890756214, -2.9998838916062023 39.3802075165436, ' \
                 '-2.9998836867583814 39.50347350652428, -2.999883480648371 39.62673687536334, ' \
                 '-2.9998832732675598 39.74999762096865))'

UPU_32_POLYGON = 'POLYGON ((10.360679924926274 48.744709489724116, 10.546698567567525 48.74236244304076, ' \
                 '10.732691670117585 48.73971525860449, 10.918656168718003 48.73676804398342, ' \
                 '11.104589002490243 48.7335209189038, 11.290487113852816 48.72997401523444, ' \
                 '11.476347448837526 48.72612747696944, 11.662166957404777 48.72198146020943, ' \
                 '11.84794259375782 48.717536133141195, 11.852016106289703 48.71743529535449, ' \
                 '11.845085587429464 48.59452013778996, 11.83820164536958 48.47160160775262, ' \
                 '11.83136388080764 48.3486797104305, 11.824571899175107 48.22575445098277, ' \
                 '11.817825310568395 48.10282583454092, 11.81112372968118 47.979893866209835, ' \
                 '11.804466775737888 47.856958551069035, 11.797854072428335 47.734019894173684, ' \
                 '11.797709550032868 47.731323833588604, 11.793713354520815 47.731421260277344, ' \
                 '11.611464927903889 47.73571619985514, 11.429175534549298 47.73972193228199, ' \
                 '11.24684801941456 47.743438299791926, 11.064485231230805 47.74686515595978, ' \
                 '10.882090022223103 47.75000236571954, 10.6996652478299 47.752849805381196, ' \
                 '10.517213766421618 47.75540736264628, 10.33473843901855 47.75767493662188, ' \
                 '10.334807472876129 47.76037347321792, 10.337966169841163 47.883425306901685, ' \
                 '10.341146031913048 48.00647433184393, 10.344347239472953 48.12952054785841, ' \
                 '10.347569975047941 48.25256395479094, 10.350814423342472 48.3756045525191, ' \
                 '10.354080771270466 48.498642340951974, 10.35736920798795 48.62167732002992, ' \
                 '10.360679924926274 48.744709489724116))'

in_dir = sys.argv[1]
out_dir = sys.argv[2]
out_name = sys.argv[3]
data_type = 'S2L2'
dataset_list = []
dir_content = os.listdir(in_dir)
for tile_no in dir_content:
    if os.path.isdir(in_dir + '/' + tile_no):
        tile_no_content = os.listdir(in_dir + '/' + tile_no)
        for tile_id_1 in tile_no_content:
            path_0 = in_dir + '/' + tile_no + '/' + tile_id_1
            if os.path.isdir(path_0):
                tile_id_1_content = os.listdir(path_0)
                for tile_id_2 in tile_id_1_content:
                    path_1 = path_0 + '/' + tile_id_2
                    if os.path.isdir(path_1):
                        tile_id_2_content = os.listdir(path_1)
                        for year in tile_id_2_content:
                            path_2 = path_1 + '/' + year
                            if os.path.isdir(path_2):
                                year_content = os.listdir(path_2)
                                for month in year_content:
                                    path_3 = path_2 + '/' + month
                                    if os.path.isdir(path_3):
                                        month_content = os.listdir(path_3)
                                        for day in month_content:
                                            path_4 = path_3 + '/' + day
                                            if os.path.isdir(path_4):
                                                day_content = os.listdir(path_4)
                                                for folder in day_content:
                                                    path_5 = path_4 + '/' + folder
                                                    dataset = {}
                                                    dataset['data_type'] = data_type
                                                    dataset['name'] = path_5
                                                    dataset['start_time'] = '{:04d}-{:02d}-{:02d}'.\
                                                        format(int(year), int(month), int(day))
                                                    dataset['end_time'] = '{:04d}-{:02d}-{:02d}'.\
                                                        format(int(year), int(month), int(day))
                                                    if tile_no == '30' and tile_id_1 == 'S' and tile_id_2 == 'WJ':
                                                        dataset['spatial_coverage'] = SWJ_30_POLYGON
                                                    elif tile_no == '32' and tile_id_1 == 'U' and tile_id_2 == 'PU':
                                                        dataset['spatial_coverage'] = UPU_32_POLYGON
                                                    dataset_list.append(dataset)
datasets = {}
datasets['datasets'] = dataset_list
with open(out_dir +'/' + out_name, 'w') as out_file:
    json.dump(datasets, out_file)
